var FetchedJsonData = {
  "AnswersSpreadsheet": [
    {
      "id": "Community",
      "text": "<strong>Community Builder / Sustainability Coordinator</strong> – e.g. community energy organizer, green job coach, retrofit outreach officer."
    },
    {
      "id": "Communicator",
      "text": "<strong>Communicator / Creative Advocate</strong> – e.g. sustainability content creator, environmental educator, climate communications officer."
    },
    {
      "id": "Analyst",
      "text": "<strong>Researcher / Sustainability Analyst</strong> – e.g. carbon analyst, ESG data specialist, environmental policy researcher."
    },
    {
      "id": "Builder",
      "text": "<strong>Hands-on Technical Role / Green Construction Worker</strong> – e.g. solar installer, heat pump engineer, EV technician."
    },
    {
      "id": "Grower",
      "text": "<strong>Nature-Based Role / Conservation or Agroecology</strong> – e.g. park ranger, urban greening officer, organic grower."
    }
  ],
  "QuestionsSpreadsheet": [
    {
      "id": "Q1",
      "text": "What type of work environment appeals to you the most?",
      "questionTypeId": "ENVIRONMENT"
    },
    {
      "id": "Q2",
      "text": "Which activity sounds most fulfilling to you?",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "Q3",
      "text": "When you work on a group project, what role do you usually take?",
      "questionTypeId": "WORK_STYLE"
    },
    {
      "id": "Q4",
      "text": "What do people often compliment you on?",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "Q5",
      "text": "If you could volunteer for a day, which project would you choose?",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "Q6",
      "text": "Which statement sounds most like you?",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "Q7",
      "text": "What is your dream scenario for making an impact?",
      "questionTypeId": "IMPACT_STYLE"
    },
    {
      "id": "Q8",
      "text": "Which school subject or activity do/did you enjoy the most?",
      "questionTypeId": "INTEREST"
    }
  ],
  "ChoicesSpreadsheet": [
    {
      "id": "C1",
      "questionId": "Q1",
      "text": "Outdoors, working directly with nature",
      "answerId": "Community",
      "questionTypeId": "ENVIRONMENT"
    },
    {
      "id": "C2",
      "questionId": "Q1",
      "text": "In a lab or office, researching or planning",
      "answerId": "Analyst",
      "questionTypeId": "ENVIRONMENT"
    },
    {
      "id": "C3",
      "questionId": "Q1",
      "text": "On-site or workshop, using tools and tech",
      "answerId": "Builder",
      "questionTypeId": "ENVIRONMENT"
    },
    {
      "id": "C4",
      "questionId": "Q1",
      "text": "Collaborative setting, interacting with people",
      "answerId": "Communicator",
      "questionTypeId": "ENVIRONMENT"
    },
    {
      "id": "C5",
      "questionId": "Q2",
      "text": "Protecting nature or farming sustainably",
      "answerId": "Grower",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C6",
      "questionId": "Q2",
      "text": "Developing eco-friendly tech or solutions",
      "answerId": "Builder",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C7",
      "questionId": "Q2",
      "text": "Educating and inspiring others",
      "answerId": "Communicator",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C8",
      "questionId": "Q2",
      "text": "Analyzing and planning sustainability policy",
      "answerId": "Analyst",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C9",
      "questionId": "Q3",
      "text": "Team leader",
      "answerId": "Community",
      "questionTypeId": "WORK_STYLE"
    },
    {
      "id": "C10",
      "questionId": "Q3",
      "text": "Ideas person",
      "answerId": "Communicator",
      "questionTypeId": "WORK_STYLE"
    },
    {
      "id": "C11",
      "questionId": "Q3",
      "text": "Technical expert",
      "answerId": "Analyst",
      "questionTypeId": "WORK_STYLE"
    },
    {
      "id": "C12",
      "questionId": "Q3",
      "text": "Supporter",
      "answerId": "Grower",
      "questionTypeId": "WORK_STYLE"
    },
    {
      "id": "C13",
      "questionId": "Q4",
      "text": "Good listener and communicator",
      "answerId": "Community",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C14",
      "questionId": "Q4",
      "text": "Logical and analytical",
      "answerId": "Analyst",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C15",
      "questionId": "Q4",
      "text": "Creative and imaginative",
      "answerId": "Communicator",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C16",
      "questionId": "Q4",
      "text": "Practical and resourceful",
      "answerId": "Builder",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C17",
      "questionId": "Q5",
      "text": "Community cleanup or tree-planting event",
      "answerId": "Grower",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C18",
      "questionId": "Q5",
      "text": "Installing solar or energy devices",
      "answerId": "Builder",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C19",
      "questionId": "Q5",
      "text": "Teach or create a video on sustainability",
      "answerId": "Communicator",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C20",
      "questionId": "Q5",
      "text": "Organize fundraiser or campaign for policy",
      "answerId": "Community",
      "questionTypeId": "MOTIVATION"
    },
    {
      "id": "C21",
      "questionId": "Q6",
      "text": "I care for people and planet",
      "answerId": "Community",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C22",
      "questionId": "Q6",
      "text": "I solve puzzles and understand how things work",
      "answerId": "Analyst",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C23",
      "questionId": "Q6",
      "text": "I come up with creative ideas",
      "answerId": "Communicator",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C24",
      "questionId": "Q6",
      "text": "I prefer hands-on, practical results",
      "answerId": "Builder",
      "questionTypeId": "STRENGTHS"
    },
    {
      "id": "C25",
      "questionId": "Q7",
      "text": "Empowering a community",
      "answerId": "Community",
      "questionTypeId": "IMPACT_STYLE"
    },
    {
      "id": "C26",
      "questionId": "Q7",
      "text": "Inventing clean energy tech or sustainable cities",
      "answerId": "Builder",
      "questionTypeId": "IMPACT_STYLE"
    },
    {
      "id": "C27",
      "questionId": "Q7",
      "text": "Inspiring action through media",
      "answerId": "Communicator",
      "questionTypeId": "IMPACT_STYLE"
    },
    {
      "id": "C28",
      "questionId": "Q7",
      "text": "Researching or guiding eco policies",
      "answerId": "Analyst",
      "questionTypeId": "IMPACT_STYLE"
    },
    {
      "id": "C29",
      "questionId": "Q8",
      "text": "Science or Geography",
      "answerId": "Grower",
      "questionTypeId": "INTEREST"
    },
    {
      "id": "C30",
      "questionId": "Q8",
      "text": "Math or Technology",
      "answerId": "Analyst",
      "questionTypeId": "INTEREST"
    },
    {
      "id": "C31",
      "questionId": "Q8",
      "text": "Art, English or Media",
      "answerId": "Communicator",
      "questionTypeId": "INTEREST"
    },
    {
      "id": "C32",
      "questionId": "Q8",
      "text": "Social studies or community projects",
      "answerId": "Community",
      "questionTypeId": "INTEREST"
    }
  ],
  "QuestionTypesSpreadsheet": [
    {
      "id": "ENVIRONMENT",
      "text": "Preferred work setting/environment"
    },
    {
      "id": "MOTIVATION",
      "text": "Motivating activities and purpose"
    },
    {
      "id": "WORK_STYLE",
      "text": "Team roles and working style"
    },
    {
      "id": "STRENGTHS",
      "text": "Personal traits and soft skills"
    },
    {
      "id": "IMPACT_STYLE",
      "text": "Desired impact on the world"
    },
    {
      "id": "INTEREST",
      "text": "Subject interests and academic strengths"
    }
  ]
};

function QuestionType( options ){
  var self = this;
  Object.keys(options).forEach(function (key) {
    self[key] = options[key] || null;
  });
};
function Question( options ){
  var self = this;
  Object.keys(options).forEach(function (key) {
    self[key] = options[key] || null;
  });
};

function Answer( options ){
  var self = this;
  Object.keys(options).forEach(function (key) {
    self[key] = options[key] || null;
  });
};

function Choice( options ){
  var self = this;
  Object.keys(options).forEach(function (key) {
    self[key] = options[key] || null;
  });
};

var EngineNameSpace = {
  listOfQuestionTypes : [],
  listOfQuestions : [],
  listOfChoices : [],
  listOfAnswers : [],
  listOfChosenChoices : [],
  currentQuestion : 0
};

var Types = {
  'questionType' : {
    'listName' : 'listOfQuestionTypes',
    'args' : []
  },
  'question' : {
    'listName' : 'listOfQuestions',
    'args' : []
  },
  'answer' : {
    'listName' : 'listOfAnswers',
    'args' : []
  },
  'choice' : {
    'listName' : 'listOfChoices',
    'args' : []
  },
  'chosenChoice' : {
    'listName' : 'listOfChosenChoices',
    'args' : []
  }
};

function ObjectFactory() {}

ObjectFactory.prototype.objectClass = QuestionType;

ObjectFactory.prototype.createObject = function( options ){
  switch(options.objectType){
    case 'questionType':
      this.objectType = QuestionType;
      break;
    case 'question':
      this.objectType = Question;
      break;
    case 'answer':
      this.objectType = Answer;
      break;
    case 'choice':
      this.objectType = Choice;
      break;
  }

  return new this.objectType( options );
};

Utils = {
  pushObjectToList : function(listType, givenObject){
    EngineNameSpace[listType].push(givenObject);
  },
  createOptionsForObject : function(type, startIndex, numberOfArguments, entryList){
    var options = {objectType: type};
    for (var i = 0; i < numberOfArguments; i++){
      positionInEntryList = startIndex + i;
      options[Types[type]['args'][i]] = entryList[positionInEntryList].gs$cell.$t;
    }
    return options;
  },
  populateList : function(type, entryList){
    Utils.readHeaders(type, entryList);
    var entriesLength = entryList.length;
    var listType = Utils.getListNameFromType(type);
    var numberOfArguments = Utils.getNumberOfArgumentsFromType(type);
    objectFactory = new ObjectFactory();

    for (var i = numberOfArguments; i < entriesLength; i = i + numberOfArguments){
      Utils.pushObjectToList(listType, objectFactory.createObject(Utils.createOptionsForObject(type, i, numberOfArguments, entryList)));
    }
  },
  getListNameFromType : function(type){
    return Types[type]['listName'];
  },
  getNumberOfArgumentsFromType: function(type){
    return Types[type]['args'].length;
  },
  readHeaders : function(type, entryList){
    Types[type]['args'] = [];
    var i = 0;
    while(entryList[i].gs$cell.row < 2){
      Types[type]['args'].push(entryList[i].gs$cell.$t);
      i += 1;
    }
  }
}

QuizRunner = {
  getRadioOptionContainer: function(name, value, text){
    return "<label class='choice'><div class='choice-radio-button'><input type='radio' value='" + value + "' name='" + name + "'></div><div class='choice-text'>" + text + "</div></label>";
  },
  getChoicesForQuestion: function(questionId){
    return _.filter(EngineNameSpace.listOfChoices, function(choice){ if ( choice.questionId == questionId ) { return choice;} });
  },
  getElementFromListById: function(list, elementId){
    return _.find(list, function(q){ if ( q.pid == elementId ) { return q; }});
  },
  fillQuestionContainer: function(questionId){
    $('#question-text').text(QuizRunner.getElementFromListById(EngineNameSpace['listOfQuestions'], questionId).questionText);
    $('#quiz-status').text('QUESTION ' + questionId + '/' + EngineNameSpace.listOfQuestions.length.toString());
    var choices = QuizRunner.shuffle(QuizRunner.getChoicesForQuestion(questionId));
    $('#choices').empty();
    _.each(choices, function(choice){ $("#choices").append(QuizRunner.getRadioOptionContainer(choice.questionId, choice.pid, choice.choiceText))})
  },
  pushChosenChoice : function(choiceId){
    var choice = QuizRunner.getElementFromListById(EngineNameSpace['listOfChoices'], choiceId);
    Utils.pushObjectToList('listOfChosenChoices', choice);
  },
  showNextQuestion: function(){
    if (EngineNameSpace.currentQuestion < EngineNameSpace.listOfQuestions.length) {
      $('.screen').hide();
      $('#quiz-container').show();
      EngineNameSpace.currentQuestion += 1;
      QuizRunner.fillQuestionContainer((EngineNameSpace.currentQuestion).toString());
    }
    else {
      $('.screen').hide();
      QuizRunner.displayResults();
      $('#results-container').show();
    }
  },
  groupChoicesByQuestionTypes: function(){
    return _.groupBy(EngineNameSpace.listOfChosenChoices, function(choice){
      return choice.questionTypeId;
    });
  },
  groupChoicesByAnswers: function(choices){
    return _.groupBy(choices, function(choice){
      return choice.answerId;
    });
  },
  findMostSuitableAnswer: function(groupByAnswers){
    var answerCounts = [];
    _.each(groupByAnswers, function(value, key){
      var answerData = {'answerId' : key, 'numberOfElements' : value.length};
      answerCounts.push(answerData);
    });
    return (_.max(answerCounts, function(answer){ return answer.numberOfElements})).answerId;
  },
  updateRoleOnConfirmationScreen: function(chosenAnswer){
    if(chosenAnswer.pid < 5){
      $("#role-text").text(chosenAnswer.answerName);
    }
  },
  displayResults: function(){
    var groupByQuestionTypes = QuizRunner.groupChoicesByQuestionTypes();
    _.each(groupByQuestionTypes, function(value, key) {
      var result = $("<li class='result'></li>");
      var groupByAnswers = QuizRunner.groupChoicesByAnswers(value);
      var chosenAnswerId = QuizRunner.findMostSuitableAnswer(groupByAnswers);
      var chosenAnswer = QuizRunner.getElementFromListById(EngineNameSpace.listOfAnswers, chosenAnswerId);
      var answerElement = "<span class='answer-text'>" + chosenAnswer.answerText + "</span>";
      result.append(answerElement);
      $("#results-section").append(result);
      QuizRunner.updateRoleOnConfirmationScreen(chosenAnswer);
    });
  },
  //Added from http://stackoverflow.com/a/2450976
  shuffle: function(array) {
    var currentIndex = array.length, temporaryValue, randomIndex ;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }

    return array;
  }
};

$(document).ready( function(){
  Utils.populateList('questionType', FetchedJsonData.QuestionTypesSpreadsheet);
  Utils.populateList('answer', FetchedJsonData.AnswersSpreadsheet);
  Utils.populateList('question', FetchedJsonData.QuestionsSpreadsheet);
  Utils.populateList('choice', FetchedJsonData.ChoicesSpreadsheet);
  
  EngineNameSpace.currentQuestion = 0;
  QuizRunner.showNextQuestion();

  $('#submit-choice').click(function(event){
    event.preventDefault();
    var radioChecked = $('#questionnaire input[type=radio]:checked');
    if ( radioChecked.length === 0  ){
      $("#error-field").show();
    }
    else {
      $("#error-field").hide();
      QuizRunner.pushChosenChoice(radioChecked[0].value);
      QuizRunner.showNextQuestion();
    }
  });
});
